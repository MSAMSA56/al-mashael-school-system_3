<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ููุญุฉ ุงููุนูู - ุงููุดุงุนู</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Cairo,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b1220;color:#eef2ff}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#0f172a;position:sticky;top:0;border-bottom:1px solid #233054}
    header .brand{font-weight:800;letter-spacing:.4px}
    header nav a{color:#9fb4ff;margin-inline:8px;text-decoration:none}
    .container{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:#111a33;border:1px solid #263458;border-radius:14px;padding:16px;margin-bottom:16px}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    input,select,button,textarea{background:#0f1a34;color:#eaf0ff;border:1px solid #2a3c64;border-radius:10px;padding:10px 12px}
    button{cursor:pointer;background:#3757ff;border-color:#4a66ff}
    button.secondary{background:#132146}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #233054}
    .muted{color:#a8b3d6}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#132146;color:#9fb4ff;border:1px solid #233054}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .flex{display:flex;align-items:center;gap:8px}
    .right{margin-inline-start:auto}
    .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div class="brand">ุงููุดุงุนู โข ููุญุฉ ุงููุนูู ๐จโ๐ซ</div>
    <nav>
      <a href="#" id="profileLink">ุญุณุงุจู ุงูุดุฎุตู</a>
      <a href="#" id="chatLink">ุบุฑู ุงููุญุงุฏุซุฉ</a>
      <a href="index.html">ุชุณุฌูู ุงูุฎุฑูุฌ</a>
      <a href="dashboard-student.html">ููุญุฉ ุงูุทุงูุจ</a>
      <a href="dashboard-admin.html">ููุญุฉ ุงูุฅุฏุงุฑุฉ</a>
      <a href="dashboard-manager.html">ููุญุฉ ุงููุฏูุฑ ุงูุนุงู</a>
    </nav>
  </header>

  <div class="container">
    <div class="grid">
      <section class="card">
        <h2>ุฅุฏุงุฑุฉ ุงููุงุฌุจุงุช ูุงูุงูุชุญุงูุงุช</h2>
        <div class="row">
          <select id="assignType">
            <option value="homework">ูุงุฌุจ</option>
            <option value="exam">ุงูุชุญุงู</option>
          </select>
          <select id="assignGrade">
            <option value="">ุงุฎุชุฑ ุงููุฑุญูุฉ</option>
            <option value="ุซุงููู-1">ุฃูู ุซุงููู</option>
            <option value="ุซุงููู-2">ุซุงูู ุซุงููู</option>
            <option value="ุซุงููู-3">ุซุงูุซ ุซุงููู</option>
          </select>
          <input id="assignSubject" placeholder="ุงููุงุฏุฉ (ูุซุงู: ุฑูุงุถูุงุช)" />
          <input id="assignLink" placeholder="ุฑุงุจุท ุงููุงุฌุจ/ุงูุงูุชุญุงู (URL)" />
          <button id="publishAssignment">ูุดุฑ ุงููุงุฌุจ/ุงูุงูุชุญุงู</button>
        </div>
        <p class="muted">ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ููุทุงูุจ ุจูุตูู ุฑุงุจุท ุงููุงุฌุจ/ุงูุงูุชุญุงู. ูุฌุจ ุนูู ุงูุทุงูุจ ุงูุถุบุท ุนูู ุงูุฑุงุจุท ููุชู ุชุณุฌููู ูู "ุชู ุงูุญู".</p>
      </section>

      <aside class="card">
        <h2>ุชุณุฌูู ุงูุญุถูุฑ ูุงูุบูุงุจ</h2>
        <div class="row">
          <select id="attendanceGrade">
            <option value="">ุงุฎุชุฑ ุงูุตู</option>
          </select>
          <select id="attendanceClass">
            <option value="">ุงุฎุชุฑ ุงูุดุนุจุฉ</option>
          </select>
          <button id="loadStudentsForAttendance">ุชุญููู ุงูุทูุงุจ</button>
        </div>
        <table id="attendanceTable">
          <thead><tr><th>ุงูุทุงูุจ</th><th>ุญุงูุฉ ุงูุญุถูุฑ</th><th>ุชุณุฌูู</th></tr></thead>
          <tbody id="attendanceBody"></tbody>
        </table>
        <button id="saveAttendance" style="margin-top: 10px;">ุญูุธ ุงูุญุถูุฑ/ุงูุบูุงุจ</button>
      </aside>
    </div>
    <div class="grid" style="margin-top: 14px;">
      <section class="card">
        <h2>ุญุตุตู ุงูููู</h2>
        <div class="row">
          <select id="gradeSelect">
            <option value="">ุงุฎุชุฑ ุงูุตู</option>
          </select>
          <select id="classSelect">
            <option value="">ุงุฎุชุฑ ุงูุดุนุจุฉ</option>
          </select>
          <button id="loadSchedule">ุชุญููู ุงูุฌุฏูู</button>
          <span class="right pill" id="teacherName">โ</span>
        </div>
        <table>
          <thead>
            <tr><th>ุงููุงุฏุฉ</th><th>ุงูุตู/ุงูุดุนุจุฉ</th><th>ุงูุญุตุฉ</th><th>ุงูููุช</th><th>ุงูุบุฑูุฉ</th></tr>
          </thead>
          <tbody id="scheduleBody"></tbody>
        </table>
      </section>

      <aside class="card">
        <h2>ุฅุฏุฎุงู ุงูุฏุฑุฌุงุช</h2>
        <p class="muted">ููุงุญุธุฉ: ุณูุชู ุฅุฑุณุงู ุงููุชูุฌุฉ ุฅูู ุงูุฅุฏุงุฑุฉ/ุงููุฏูุฑ ุชููุงุฆูุงู.</p>
        <div class="row">
          <input id="studentId" placeholder="ุฑูู ุงูุทุงูุจ" />
          <input id="subject" placeholder="ุงููุงุฏุฉ" />
          <input id="score" placeholder="ุงูุฏุฑุฌุฉ" type="number" min="0" max="100" />
          <button id="saveScore">ุญูุธ</button>
        </div>
        <p class="muted">ุณูุชู ุญูุธ ุงูุฏุฑุฌุงุช ูู ูุฌููุนุฉ grades ููู ุทุงูุจ.</p>
      </aside>
    </div>

    <section class="card">
      <h2>ุณุฌู ุงูุฏุฑุฌุงุช ุงูุฃุฎูุฑุฉ</h2>
      <table>
        <thead><tr><th>ุงูุทุงูุจ</th><th>ุงููุงุฏุฉ</th><th>ุงูุฏุฑุฌุฉ</th><th>ุชุงุฑูุฎ</th></tr></thead>
        <tbody id="recentGrades"></tbody>
      </table>
    </section>
  </div>

  <script>
    // ุฅุถุงูุฉ ุจูุงูุงุช ููููุฉ ููุตููู ูุงููุฑุงุญู
    const GRADES = [
      { id: 'ุซุงููู-1', name: 'ุงูุตู ุงูุฃูู ุงูุซุงููู', classes: ['ุฃ', 'ุจ'] },
      { id: 'ุซุงููู-2', name: 'ุงูุตู ุงูุซุงูู ุงูุซุงููู', classes: ['ุฃ', 'ุจ'] },
      { id: 'ุซุงููู-3', name: 'ุงูุตู ุงูุซุงูุซ ุงูุซุงููู', classes: ['ุฃ', 'ุจ'] },
    ];

    // ูุธููุฉ ุนุงูุฉ ูููุก ูุงุฆูุฉ ุงููุฑุงุญู
    function populateGrades(selectId) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฑุญูุฉ</option>';
      GRADES.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade.id;
        option.textContent = grade.name;
        select.appendChild(option);
      });
    }

    // ูุธููุฉ ูููุก ูุงุฆูุฉ ุงูุตููู ูุงูุดุนุจ (ููุญุถูุฑ)
    function populateAttendanceGrades() {
      const select = document.getElementById('attendanceGrade');
      select.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุตู</option>';
      GRADES.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade.id;
        option.textContent = grade.name;
        select.appendChild(option);
      });
      document.getElementById('attendanceGrade').addEventListener('change', (e) => {
        const gradeId = e.target.value;
        const classSelect = document.getElementById('attendanceClass');
        classSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุดุนุจุฉ</option>';
        const grade = GRADES.find(g => g.id === gradeId);
        if (grade) {
          grade.classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls;
            option.textContent = cls;
            classSelect.appendChild(option);
          });
        }
      });
    }

    // ููุทู ูุดุฑ ุงููุงุฌุจ/ุงูุงูุชุญุงู
    document.getElementById('publishAssignment').addEventListener('click', async () => {
      const type = document.getElementById('assignType').value;
      const grade = document.getElementById('assignGrade').value;
      const subject = document.getElementById('assignSubject').value.trim();
      const link = document.getElementById('assignLink').value.trim();
      const teacherId = auth?.currentUser?.uid || 'demo-teacher';

      if (!grade || !subject || !link) {
        alert('ุงูุฑุฌุงุก ููุก ุฌููุน ุญููู ุงููุงุฌุจ/ุงูุงูุชุญุงู.');
        return;
      }

      try {
        // ุฅุถุงูุฉ ุงููุงุฌุจ/ุงูุงูุชุญุงู ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        await db.collection('assignments').add({
          type, grade, subject, link, teacherId,
          status: 'pending',
          createdAt: new Date(),
        });

        // ุฅุฑุณุงู ุฅุดุนุงุฑ (ูุญุงูุงุฉ)
        alert(`ุชู ูุดุฑ ${type === 'homework' ? 'ุงููุงุฌุจ' : 'ุงูุงูุชุญุงู'} ุจูุฌุงุญ ููุตู ${grade} ูู ูุงุฏุฉ ${subject}. ุณูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ููุทูุงุจ.`);

        // ูุณุญ ุงูุญููู
        document.getElementById('assignSubject').value = '';
        document.getElementById('assignLink').value = '';

      } catch (error) {
        console.error('ุฎุทุฃ ูู ูุดุฑ ุงููุงุฌุจ/ุงูุงูุชุญุงู:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุดุฑ.');
      }
    });

    // ููุทู ุชุญููู ุงูุทูุงุจ ูุชุณุฌูู ุงูุญุถูุฑ (ูุญุงูุงุฉ)
    document.getElementById('loadStudentsForAttendance').addEventListener('click', async () => {
      const grade = document.getElementById('attendanceGrade').value;
      const classId = document.getElementById('attendanceClass').value;
      const tbody = document.getElementById('attendanceBody');
      tbody.innerHTML = '';

      if (!grade || !classId) {
        alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุตู ูุงูุดุนุจุฉ ุฃููุงู.');
        return;
      }

      // ูุญุงูุงุฉ ุชุญููู ูุงุฆูุฉ ุงูุทูุงุจ
      const students = [
        { id: 'S001', name: 'ุฃุญูุฏ ูุญูุฏ', uid: 'student-uid-1' },
        { id: 'S002', name: 'ุฎุงูุฏ ุนูู', uid: 'student-uid-2' },
        { id: 'S003', name: 'ุณุงุฑุฉ ููุฏ', uid: 'student-uid-3' },
      ];

      students.forEach(student => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${student.name} (${student.id})</td>
          <td>
            <select id="status-${student.uid}">
              <option value="present">ุญุงุถุฑ</option>
              <option value="absent">ุบุงุฆุจ</option>
              <option value="late">ูุชุฃุฎุฑ</option>
            </select>
          </td>
          <td><button class="secondary" onclick="saveSingleAttendance('${student.uid}', '${student.name}')">ุญูุธ</button></td>
        `;
        tbody.appendChild(tr);
      });
    });

    // ููุทู ุญูุธ ุงูุญุถูุฑ ูุงูุบูุงุจ (ูุญุงูุงุฉ)
    window.saveSingleAttendance = async (studentUid, studentName) => {
      const status = document.getElementById(`status-${studentUid}`).value;
      const date = new Date().toISOString().split('T')[0]; // ุชุงุฑูุฎ ุงูููู

      try {
        // ุญูุธ ุณุฌู ุงูุบูุงุจ ูู ูุฌููุนุฉ attendanceReport ููุทุงูุจ
        await db.collection('attendanceReport').doc(studentUid).collection('records').add({
          date,
          status,
          teacherId: auth?.currentUser?.uid || 'demo-teacher',
          grade: document.getElementById('attendanceGrade').value,
          classId: document.getElementById('attendanceClass').value,
        });

        alert(`ุชู ุญูุธ ุญุงูุฉ ุงูุทุงูุจ ${studentName} ูู ${status === 'absent' ? 'ุบุงุฆุจ' : status === 'late' ? 'ูุชุฃุฎุฑ' : 'ุญุงุถุฑ'}. ุณูุชู ุฅุฑุณุงู ุชูุฑูุฑ ููุทุงูุจ.`);
      } catch (error) {
        console.error('ุฎุทุฃ ูู ุญูุธ ุงูุญุถูุฑ:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุญุถูุฑ ูุงูุบูุงุจ.');
      }
    };
    
    document.getElementById('saveAttendance').addEventListener('click', () => alert('ูุฑุฌู ุงุณุชุฎุฏุงู ุฒุฑ "ุญูุธ" ุจุฌูุงุฑ ูู ุทุงูุจ ูุญูุธ ุณุฌู ุงูุบูุงุจ.'));

    // ุฑูุงุจุท ููููุฉ ูุบุฑู ุงููุญุงุฏุซุฉ ูุงูุญุณุงุจ ุงูุดุฎุตู
    document.getElementById('profileLink').addEventListener('click', (e) => {
      e.preventDefault();
      alert('ุณูุชู ุชูุฌููู ุฅูู ุตูุญุฉ ุชุนุฏูู ุงูุญุณุงุจ ุงูุดุฎุตู ูุทุฑู ุงูุชูุงุตู.');
    });
    document.getElementById('chatLink').addEventListener('click', (e) => {
      e.preventDefault();
      alert('ุณูุชู ุชูุฌููู ุฅูู ุบุฑู ุงููุญุงุฏุซุฉ ููุชูุงุตู ูุน ุงูุทูุงุจ ูุงููุนูููู.');
    });

    // ... (ุจููุฉ ุงูููุฏ)

    populateGrades('assignGrade');
    populateAttendanceGrades();
    const firebaseConfig = { apiKey:"", authDomain:"", projectId:"", appId:"" };
    let app, db, auth;
    try { app = firebase.initializeApp(firebaseConfig); db = firebase.firestore(); auth = firebase.auth(); }
    catch(e){ console.warn('Firebase ูู ููููุฃ ุจุนุฏ.'); }

    async function populateGradeClass(){
      if(!db) return;
      const gradeSel = document.getElementById('gradeSelect');
      gradeSel.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุตู</option>';
      const gradesSnap = await db.collection('gradesMeta').get();
      gradesSnap.forEach(g=>{ const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.data().name||g.id; gradeSel.appendChild(opt); });
      document.getElementById('classSelect').innerHTML = '<option value="">ุงุฎุชุฑ ุงูุดุนุจุฉ</option>';
    }

    document.getElementById('gradeSelect').addEventListener('change', async (e)=>{
      const gradeId = e.target.value; const classSel = document.getElementById('classSelect');
      classSel.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุดุนุจุฉ</option>';
      if(!db||!gradeId) return;
      const classes = await db.collection('gradesMeta').doc(gradeId).collection('classes').get();
      classes.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.data().name||c.id; classSel.appendChild(opt); });
    });

    document.getElementById('loadSchedule').addEventListener('click', async ()=>{
      const gradeId=document.getElementById('gradeSelect').value;
      const classId=document.getElementById('classSelect').value;
      const tbody=document.getElementById('scheduleBody'); tbody.innerHTML='';
      if(!db||!gradeId||!classId) return;
      const teacherUid = auth?.currentUser?.uid || 'demo-teacher';
      document.getElementById('teacherName').textContent = teacherUid;
      const q = await db.collection('schedules')
        .where('gradeId','==',gradeId).where('classId','==',classId).where('teacherId','==',teacherUid).get();
      q.forEach(doc=>{ const s=doc.data(); const tr=document.createElement('tr');
        tr.innerHTML = `<td>${s.subject||''}</td><td>${s.gradeId}/${s.classId}</td><td>${s.period||''}</td><td>${s.time||''}</td><td>${s.room||''}</td>`; tbody.appendChild(tr); });
    });

    document.getElementById('saveScore').addEventListener('click', async ()=>{
      const studentId=document.getElementById('studentId').value.trim();
      const subject=document.getElementById('subject').value.trim();
      const score=Number(document.getElementById('score').value);
      if(!db||!studentId||!subject||Number.isNaN(score)) return alert('ุฃููู ุงูุญููู');
      await db.collection('students').doc(studentId).collection('grades').add({ subject, score, createdAt:new Date(), teacherId:auth?.currentUser?.uid||'demo-teacher' });
      document.getElementById('studentId').value=''; document.getElementById('subject').value=''; document.getElementById('score').value='';
      loadRecentGrades();
    });

    async function loadRecentGrades(){
      const tbody=document.getElementById('recentGrades'); tbody.innerHTML=''; if(!db) return;
      const q=await db.collectionGroup('grades').orderBy('createdAt','desc').limit(10).get();
      q.forEach(doc=>{ const g=doc.data(); const tr=document.createElement('tr');
        const dt=g.createdAt?.toDate?g.createdAt.toDate():g.createdAt;
        tr.innerHTML = `<td>${g.studentId||doc.ref.parent.parent?.id||''}</td><td>${g.subject||''}</td><td>${g.score||''}</td><td>${dt? new Date(dt).toLocaleString('ar-EG'):''}</td>`; tbody.appendChild(tr); });
    }

    populateGradeClass(); loadRecentGrades();
  </script>
</body>
</html>
