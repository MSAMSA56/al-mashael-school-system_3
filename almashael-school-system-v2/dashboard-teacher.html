<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù… - Ø§Ù„Ù…Ø´Ø§Ø¹Ù„</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Cairo,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b1220;color:#eef2ff}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:#0f172a;position:sticky;top:0;border-bottom:1px solid #233054}
    header .brand{font-weight:800;letter-spacing:.4px}
    header nav a{color:#9fb4ff;margin-inline:8px;text-decoration:none}
    .container{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:#111a33;border:1px solid #263458;border-radius:14px;padding:16px;margin-bottom:16px}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    input,select,button,textarea{background:#0f1a34;color:#eaf0ff;border:1px solid #2a3c64;border-radius:10px;padding:10px 12px}
    button{cursor:pointer;background:#3757ff;border-color:#4a66ff}
    button.secondary{background:#132146}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #233054}
    .muted{color:#a8b3d6}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#132146;color:#9fb4ff;border:1px solid #233054}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .flex{display:flex;align-items:center;gap:8px}
    .right{margin-inline-start:auto}
    .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div class="brand">Ø§Ù„Ù…Ø´Ø§Ø¹Ù„ â€¢ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù… ğŸ‘¨â€ğŸ«</div>
    <nav>
      <a href="#" id="profileLink">Ø­Ø³Ø§Ø¨ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</a>
      <a href="#" id="chatLink">ØºØ±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</a>
      <a href="index.html">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
      <a href="dashboard-student.html">Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</a>
      <a href="dashboard-admin.html">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
      <a href="dashboard-manager.html">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</a>
    </nav>
  </header>

  <div class="container">
    <div class="grid">
      <section class="card">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
        <div class="row">
          <select id="assignType">
            <option value="homework">ÙˆØ§Ø¬Ø¨</option>
            <option value="exam">Ø§Ù…ØªØ­Ø§Ù†</option>
          </select>
          <select id="assignGrade">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
            <option value="Ø«Ø§Ù†ÙˆÙŠ-1">Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="Ø«Ø§Ù†ÙˆÙŠ-2">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="Ø«Ø§Ù†ÙˆÙŠ-3">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
          </select>
          <input id="assignSubject" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø© (Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª)" />
          <input id="assignLink" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ø¨/Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† (URL)" />
          <button id="publishAssignment">Ù†Ø´Ø± Ø§Ù„ÙˆØ§Ø¬Ø¨/Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
        </div>
        <p class="muted">ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø·Ø§Ù„Ø¨ Ø¨ÙˆØµÙˆÙ„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ø¨/Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†. ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒÙ€ "ØªÙ… Ø§Ù„Ø­Ù„".</p>
      </section>

      <aside class="card">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h2>
        <div class="row">
          <select id="attendanceGrade">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
          </select>
          <select id="attendanceClass">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>
          </select>
          <button id="loadStudentsForAttendance">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        </div>
        <table id="attendanceTable">
          <thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>ØªØ³Ø¬ÙŠÙ„</th></tr></thead>
          <tbody id="attendanceBody"></tbody>
        </table>
        <button id="saveAttendance" style="margin-top: 10px;">Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„ØºÙŠØ§Ø¨</button>
      </aside>
    </div>
    <div class="grid" style="margin-top: 14px;">
      <section class="card">
        <h2>Ø­ØµØµÙŠ Ø§Ù„ÙŠÙˆÙ…</h2>
        <div class="row">
          <select id="gradeSelect">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
          </select>
          <select id="classSelect">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>
          </select>
          <button id="loadSchedule">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
          <span class="right pill" id="teacherName">â€”</span>
        </div>
        <table>
          <thead>
            <tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©</th><th>Ø§Ù„Ø­ØµØ©</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„ØºØ±ÙØ©</th></tr>
          </thead>
          <tbody id="scheduleBody"></tbody>
        </table>
      </section>

      <aside class="card">
        <h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h2>
        <p class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©/Ø§Ù„Ù…Ø¯ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
        <div class="row">
          <input id="studentId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" />
          <input id="subject" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©" />
          <input id="score" placeholder="Ø§Ù„Ø¯Ø±Ø¬Ø©" type="number" min="0" max="100" />
          <button id="saveScore">Ø­ÙØ¸</button>
        </div>
        <p class="muted">Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© grades Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨.</p>
      </aside>
    </div>

    <section class="card">
      <h2>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h2>
      <table>
        <thead><tr><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>ØªØ§Ø±ÙŠØ®</th></tr></thead>
        <tbody id="recentGrades"></tbody>
      </table>
    </section>
  </div>

  <script>
    // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ù…Ø±Ø§Ø­Ù„
    const GRADES = [
      { id: 'Ø«Ø§Ù†ÙˆÙŠ-1', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', classes: ['Ø£', 'Ø¨'] },
      { id: 'Ø«Ø§Ù†ÙˆÙŠ-2', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', classes: ['Ø£', 'Ø¨'] },
      { id: 'Ø«Ø§Ù†ÙˆÙŠ-3', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', classes: ['Ø£', 'Ø¨'] },
    ];

    // ÙˆØ¸ÙŠÙØ© Ø¹Ø§Ù…Ø© Ù„Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„
    function populateGrades(selectId) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>';
      GRADES.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade.id;
        option.textContent = grade.name;
        select.appendChild(option);
      });
    }

    // ÙˆØ¸ÙŠÙØ© Ù„Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø´Ø¹Ø¨ (Ù„Ù„Ø­Ø¶ÙˆØ±)
    function populateAttendanceGrades() {
      const select = document.getElementById('attendanceGrade');
      select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>';
      GRADES.forEach(grade => {
        const option = document.createElement('option');
        option.value = grade.id;
        option.textContent = grade.name;
        select.appendChild(option);
      });
      document.getElementById('attendanceGrade').addEventListener('change', (e) => {
        const gradeId = e.target.value;
        const classSelect = document.getElementById('attendanceClass');
        classSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>';
        const grade = GRADES.find(g => g.id === gradeId);
        if (grade) {
          grade.classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls;
            option.textContent = cls;
            classSelect.appendChild(option);
          });
        }
      });
    }

    // Ù…Ù†Ø·Ù‚ Ù†Ø´Ø± Ø§Ù„ÙˆØ§Ø¬Ø¨/Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†
    document.getElementById('publishAssignment').addEventListener('click', async () => {
      const type = document.getElementById('assignType').value;
      const grade = document.getElementById('assignGrade').value;
      const subject = document.getElementById('assignSubject').value.trim();
      const link = document.getElementById('assignLink').value.trim();
      const teacherId = auth?.currentUser?.uid || 'demo-teacher';

      if (!grade || !subject || !link) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨/Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.');
        return;
      }

      try {
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ§Ø¬Ø¨/Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await db.collection('assignments').add({
          type, grade, subject, link, teacherId,
          status: 'pending',
          createdAt: new Date(),
        });

        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± (Ù…Ø­Ø§ÙƒØ§Ø©)
        alert(`ØªÙ… Ù†Ø´Ø± ${type === 'homework' ? 'Ø§Ù„ÙˆØ§Ø¬Ø¨' : 'Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†'} Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„ØµÙ ${grade} ÙÙŠ Ù…Ø§Ø¯Ø© ${subject}. Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø·Ù„Ø§Ø¨.`);

        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('assignSubject').value = '';
        document.getElementById('assignLink').value = '';

      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù†Ø´Ø± Ø§Ù„ÙˆØ§Ø¬Ø¨/Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±.');
      }
    });

    // Ù…Ù†Ø·Ù‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± (Ù…Ø­Ø§ÙƒØ§Ø©)
    document.getElementById('loadStudentsForAttendance').addEventListener('click', async () => {
      const grade = document.getElementById('attendanceGrade').value;
      const classId = document.getElementById('attendanceClass').value;
      const tbody = document.getElementById('attendanceBody');
      tbody.innerHTML = '';

      if (!grade || !classId) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }

      // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
      const students = [
        { id: 'S001', name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', uid: 'student-uid-1' },
        { id: 'S002', name: 'Ø®Ø§Ù„Ø¯ Ø¹Ù„ÙŠ', uid: 'student-uid-2' },
        { id: 'S003', name: 'Ø³Ø§Ø±Ø© ÙÙ‡Ø¯', uid: 'student-uid-3' },
      ];

      students.forEach(student => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${student.name} (${student.id})</td>
          <td>
            <select id="status-${student.uid}">
              <option value="present">Ø­Ø§Ø¶Ø±</option>
              <option value="absent">ØºØ§Ø¦Ø¨</option>
              <option value="late">Ù…ØªØ£Ø®Ø±</option>
            </select>
          </td>
          <td><button class="secondary" onclick="saveSingleAttendance('${student.uid}', '${student.name}')">Ø­ÙØ¸</button></td>
        `;
        tbody.appendChild(tr);
      });
    });

    // Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ (Ù…Ø­Ø§ÙƒØ§Ø©)
    window.saveSingleAttendance = async (studentUid, studentName) => {
      const status = document.getElementById(`status-${studentUid}`).value;
      const date = new Date().toISOString().split('T')[0]; // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…

      try {
        // Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© attendanceReport Ù„Ù„Ø·Ø§Ù„Ø¨
        await db.collection('attendanceReport').doc(studentUid).collection('records').add({
          date,
          status,
          teacherId: auth?.currentUser?.uid || 'demo-teacher',
          grade: document.getElementById('attendanceGrade').value,
          classId: document.getElementById('attendanceClass').value,
        });

        alert(`ØªÙ… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentName} ÙƒÙ€ ${status === 'absent' ? 'ØºØ§Ø¦Ø¨' : status === 'late' ? 'Ù…ØªØ£Ø®Ø±' : 'Ø­Ø§Ø¶Ø±'}. Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø§Ù„Ø¨.`);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨.');
      }
    };
    
    document.getElementById('saveAttendance').addEventListener('click', () => alert('ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± "Ø­ÙØ¸" Ø¨Ø¬ÙˆØ§Ø± ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ù„Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨.'));

    // Ø±ÙˆØ§Ø¨Ø· ÙˆÙ‡Ù…ÙŠØ© Ù„ØºØ±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ
    document.getElementById('profileLink').addEventListener('click', (e) => {
      e.preventDefault();
      alert('Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ·Ø±Ù‚ Ø§Ù„ØªÙˆØ§ØµÙ„.');
    });
    document.getElementById('chatLink').addEventListener('click', (e) => {
      e.preventDefault();
      alert('Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ ØºØ±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†.');
    });

    // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯)

    populateGrades('assignGrade');
    populateAttendanceGrades();
    const firebaseConfig = { apiKey:"", authDomain:"", projectId:"", appId:"" };
    let app, db, auth;
    try { app = firebase.initializeApp(firebaseConfig); db = firebase.firestore(); auth = firebase.auth(); }
    catch(e){ console.warn('Firebase Ù„Ù… ÙŠÙÙ‡ÙŠØ£ Ø¨Ø¹Ø¯.'); }

    async function populateGradeClass(){
      if(!db) return;
      const gradeSel = document.getElementById('gradeSelect');
      gradeSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>';
      const gradesSnap = await db.collection('gradesMeta').get();
      gradesSnap.forEach(g=>{ const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.data().name||g.id; gradeSel.appendChild(opt); });
      document.getElementById('classSelect').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>';
    }

    document.getElementById('gradeSelect').addEventListener('change', async (e)=>{
      const gradeId = e.target.value; const classSel = document.getElementById('classSelect');
      classSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option>';
      if(!db||!gradeId) return;
      const classes = await db.collection('gradesMeta').doc(gradeId).collection('classes').get();
      classes.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.data().name||c.id; classSel.appendChild(opt); });
    });

    document.getElementById('loadSchedule').addEventListener('click', async ()=>{
      const gradeId=document.getElementById('gradeSelect').value;
      const classId=document.getElementById('classSelect').value;
      const tbody=document.getElementById('scheduleBody'); tbody.innerHTML='';
      if(!db||!gradeId||!classId) return;
      const teacherUid = auth?.currentUser?.uid || 'demo-teacher';
      document.getElementById('teacherName').textContent = teacherUid;
      const q = await db.collection('schedules')
        .where('gradeId','==',gradeId).where('classId','==',classId).where('teacherId','==',teacherUid).get();
      q.forEach(doc=>{ const s=doc.data(); const tr=document.createElement('tr');
        tr.innerHTML = `<td>${s.subject||''}</td><td>${s.gradeId}/${s.classId}</td><td>${s.period||''}</td><td>${s.time||''}</td><td>${s.room||''}</td>`; tbody.appendChild(tr); });
    });

    document.getElementById('saveScore').addEventListener('click', async ()=>{
      const studentId=document.getElementById('studentId').value.trim();
      const subject=document.getElementById('subject').value.trim();
      const score=Number(document.getElementById('score').value);
      if(!db||!studentId||!subject||Number.isNaN(score)) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„');
      await db.collection('students').doc(studentId).collection('grades').add({ subject, score, createdAt:new Date(), teacherId:auth?.currentUser?.uid||'demo-teacher' });
      document.getElementById('studentId').value=''; document.getElementById('subject').value=''; document.getElementById('score').value='';
      loadRecentGrades();
    });

    async function loadRecentGrades(){
      const tbody=document.getElementById('recentGrades'); tbody.innerHTML=''; if(!db) return;
      const q=await db.collectionGroup('grades').orderBy('createdAt','desc').limit(10).get();
      q.forEach(doc=>{ const g=doc.data(); const tr=document.createElement('tr');
        const dt=g.createdAt?.toDate?g.createdAt.toDate():g.createdAt;
        tr.innerHTML = `<td>${g.studentId||doc.ref.parent.parent?.id||''}</td><td>${g.subject||''}</td><td>${g.score||''}</td><td>${dt? new Date(dt).toLocaleString('ar-EG'):''}</td>`; tbody.appendChild(tr); });
    }

    populateGradeClass(); loadRecentGrades();
  </script>
</body>
</html>
